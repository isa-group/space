openapi: 3.0.4

info:
  title: SPACE API
  description: |
    # SPACE - Subscription and Pricing Access Control Engine

    SPACE is a pricing-driven self-adaptation microservice that leverages the iPricing and iSubscription metamodels to enforce feature-level access control in accordance with the terms of active subscription contracts.

    The API enables you to:
    - **Manage pricing for multiple services**
    - **Store and manage contracts**
    - **Enforce subscription compliance**

    ## Authentication & API Keys

    SPACE supports two types of API keys, each serving a different purpose:

    ### User API Keys
    - **Purpose**: Manage user accounts, organizations, services and pricing from the SPACE UI.
    - **Obtaining**: Authenticate via `POST /users/authenticate` endpoint with username and password
    - **Usage**: Include in `x-api-key` header for requests
    - **Accessible Roles**: `ADMIN` (full access), `USER` (access limited to own account and organizations)
    - **Access Pattern**: Can access `/users/**` and `/organizations/**` routes
    - **Example Use Cases**: 
      - Creating services
      - Managing organizations and their members
      - Viewing analytics

    ### Organization API Keys
    - **Purpose**: Perform programmatic operations within an organization's context
    - **Obtaining**: Created by organization owners/admins/managers via `POST /organizations/:organizationId/api-keys`
    - **Usage**: Include in `x-api-key` header for requests
    - **Accessible Scopes**: 
      - `ALL`: Full access to organization resources and management operations
      - `MANAGEMENT`: Full access to organization resources and limited management operations
      - `EVALUATION`: Read-only access to services/pricings and feature evaluation
    - **Access Pattern**: Can access `/services/**`, `/contracts/**`, `/features/**` routes
    - **Example Use Cases**: 
      - Programmatically manage services and pricings
      - Evaluate access to features
      - Manage contracts

    ## Organization Roles

    Users within an organization can have the following roles:

    | Role          | Permissions |
    |---------------|-------------|
    | **OWNER**     | Full control: add/remove members, manage API keys, update organization, transfer ownership |
    | **ADMIN**     | Nearly full control except cannot transfer ownership |
    | **MANAGER**   | Can manage members and services, limited API key operations (cannot perform operations on ALL-scoped API Keys) |
    | **EVALUATOR** | Read-only access to services and feature evaluation, can only remove themselves |

    ## Permission Summary by Endpoint Category

    All endpoints require an `x-api-key` header unless explicitly marked as **Public**.

    - **Public**: No authentication required
    - **User Key (ADMIN)**: Requires User API Key with ADMIN role
    - **User Key (USER)**: Requires User API Key with USER role (or ADMIN)
    - **Org Key (scope)**: Requires Organization API Key with specified scope
    - **Org Members (role)**: Requires User API key. If the key does not have ADMIN role, the user must be a member of the organization and have –at least– the specified role.

  contact:
    email: agarcia29@us.es
    name: SPACE Support
  version: 2.0.0
  license:
    name: MIT License
    url: https://opensource.org/licenses/MIT

externalDocs:
  description: "SPHERE: SaaS Pricing Holistic Evaluation and Regulation Environment"
  url: https://sphere.score.us.es/

servers:
  # - url: 'https://api.space.es/api/v1'
  #   description: Production
  - url: 'http://localhost:3000/api/v1'
    description: Development (local)

tags:
  - name: Authentication
    description: User authentication and API key management
  - name: Users
    description: User account management (User API Key only)
  - name: Organizations
    description: Organization management (User API Key only)
  - name: Services
    description: Service and pricing management (both API key types)
  - name: Contracts
    description: Subscription contract management (both API key types)
  - name: Features
    description: Feature evaluation and toggle management (Org API Key only)
  - name: Analytics
    description: System usage analytics (User ADMIN or Org Key with MANAGEMENT)
  - name: Cache
    description: Cache management (User ADMIN only)
  - name: Events
    description: WebSocket event management (Public)
  - name: Healthcheck
    description: Service health verification (Public)

paths:
  /users/authenticate:
    post:
      summary: Authenticate user and get User API Key
      description: |
        Authenticates a user with username and password and returns a User API Key 
        that can be used for subsequent authenticated requests.

        **Authentication**: Public (no API key required)
        
        **Returns**: User information along with User API Key

      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 30
                  example: john_doe
                password:
                  type: string
                  minLength: 5
                  example: securePassword123
      responses:
        '200':
          description: Successfully authenticated
          content:
            application/json:
              schema:
                type: object
                properties:
                  username:
                    type: string
                  apiKey:
                    type: string
                    description: User API Key for subsequent authenticated requests
                  role:
                    type: string
                    enum: [ADMIN, USER]
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid credentials
        '422':
          description: Request validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /users:
    get:
      summary: List all users (ADMIN only)
      description: |
        Retrieves a paginated list of all users in the system.

        **Authentication**: User API Key

        **Required Role**: ADMIN

        **Permission**: Only ADMIN users can retrieve all users

      tags:
        - Users
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized or missing API key
        '403':
          description: Forbidden - insufficient permissions (ADMIN role required)

    post:
      summary: Create new user
      description: |
        Creates a new user account with the specified credentials and role.

        **Authentication**: Public (with restrictions) or User API Key

        **Permission**: 

        - Anyone can create a new USER account (default role)
        - Only ADMIN users can create ADMIN accounts. Provide `x-api-key` with ADMIN role to create an ADMIN user.
        - A default organization is automatically created for the new user

      tags:
        - Users
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 30
                  example: alice_smith
                password:
                  type: string
                  minLength: 5
                  example: password456
                role:
                  type: string
                  enum: [ADMIN, USER]
                  default: USER
                  example: USER
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Invalid user data or username already exists
        '403':
          description: Forbidden - cannot create ADMIN user (requires ADMIN API key)
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /users/{username}:
    get:
      summary: Get user by username
      description: |
        Retrieves detailed information about a specific user

        **Authentication**: User API Key

        **Required Role**: USER

        **Permission**: Only ADMIN users can view any user's details. Otherwise, users can only view their own details.

      tags:
        - Users
      security:
        - ApiKeyAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          example: john_doe
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN role required
        '404':
          description: User not found

    put:
      summary: Update user
      description: |
        Updates a user's information including username, password, and role.

        **Authentication**: User API Key

        **Permission**: 
        - Users can update their own account (username, password)
        - Only ADMIN can update other users or modify roles to ADMIN

      tags:
        - Users
      security:
        - ApiKeyAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: new_username
                password:
                  type: string
                  minLength: 5
                  example: newPassword456
                role:
                  type: string
                  enum: [ADMIN, USER]
                  example: USER
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Invalid update data
        '403':
          description: Forbidden - insufficient permissions (ADMIN required to change role)
        '404':
          description: User not found
        '409':
          description: Username already taken

    delete:
      summary: Delete user
      description: |
        Deletes a user account and handles organization ownership transfer/deletion.

        **Authentication**: User API Key

        **Permission**: Only ADMIN users can delete other accounts

        **Cascading Actions**:
        - User is removed from all organization member lists
        - Organizations owned by user are transferred to eligible members (by role priority: ADMIN > MANAGER > EVALUATOR)
        - Organizations without eligible members are deleted
        - Default organizations (created during signup) are deleted regardless
        - User's API keys are invalidated

        **Constraints**:
        - Cannot delete the last ADMIN user in the system

      tags:
        - Users
      security:
        - ApiKeyAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: User deleted successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - cannot delete last ADMIN or insufficient permissions
        '404':
          description: User not found

  /users/{username}/api-key:
    put:
      summary: Regenerate user API Key
      description: |
        Generates a new User API Key for the specified user. This immediately invalidates 
        any previous API key for that user.

        **Authentication**: User API Key

        **Permission**: Only ADMIN users can regenerate API keys for other users

      tags:
        - Users
      security:
        - ApiKeyAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: New API Key generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  apiKey:
                    type: string
                    example: usr_random1234567890abcdef
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN role required
        '404':
          description: User not found

  /users/{username}/role:
    put:
      summary: Change user role
      description: |
        Changes a user's role between ADMIN and USER.

        **Authentication**: User API Key

        **Required Role**: ADMIN

        **Permission**: Only ADMIN users can change roles

        **Constraints**:
        - Cannot demote the last ADMIN user in the system
        - Source and target roles must be different

      tags:
        - Users
      security:
        - ApiKeyAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - role
              properties:
                role:
                  type: string
                  enum: [ADMIN, USER]
                  example: ADMIN
      responses:
        '200':
          description: User role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Invalid role value
        '403':
          description: Forbidden - cannot demote last ADMIN user
        '404':
          description: User not found

  /organizations:
    get:
      summary: List organizations
      description: |
        Retrieves a list of organizations accessible to the authenticated user.

        **Authentication**: User API Key

        **Permission**: 
        - ADMIN users: can see all organizations (subject to optional filter)
        - Regular users: can see only their own organizations

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: owner
          in: query
          schema:
            type: string
          description: Filter by owner username (ADMIN only)
      responses:
        '200':
          description: List of organizations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Organization'
        '401':
          description: Unauthorized

    post:
      summary: Create organization
      description: |
        Creates a new organization with the specified owner and details.

        **Authentication**: User API Key

        **Permission**: 
        - ADMIN users: can create for any user
        - Regular users: can only create for themselves

        **Automatic Setup**:
        - Creator becomes organization owner
        - Organization receives initial API Key with ALL scope

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - owner
              properties:
                name:
                  type: string
                  example: ACME Corporation
                owner:
                  type: string
                  example: john_doe
      responses:
        '201':
          description: Organization created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '400':
          description: Invalid organization data
        '403':
          description: Forbidden - cannot create for other users (USER role)
        '404':
          description: Owner user does not exist
        '409':
          description: Owner already has a default organization

  /organizations/{organizationId}:
    get:
      summary: Get organization details
      description: |
        Retrieves complete information about a specific organization including 
        members, API keys, and metadata.

        **Authentication**: User API Key

        **Permission**: 
        - USER user can only view organizations they own or are a member of
        - ADMIN users can view any organization

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
            format: MongoDB ObjectId
          example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Organization details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - not a member of this organization
        '404':
          description: Organization not found

    put:
      summary: Update organization
      description: |
        Updates organization properties including name and ownership.

        **Authentication**: User API Key

        **Permission**: 
        - Organization OWNER: can update name and transfer ownership
        - Organization ADMIN: can update name only
        - Organization MANAGER: can update name only
        - ADMIN user: can update name and transfer ownership

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Updated Organization Name
                owner:
                  type: string
                  example: new_owner_username
                  description: Must be an existing username (owner permission required)
      responses:
        '200':
          description: Organization updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '400':
          description: Invalid update data
        '403':
          description: Forbidden - insufficient permissions
        '404':
          description: Organization or specified owner not found
        '409':
          description: New owner already has a default organization

    delete:
      summary: Delete organization
      description: |
        Deletes an organization and all its resources (services, contracts, API keys, members).

        **Authentication**: User API Key

        **Permission**: 
        - Organization OWNER: can delete the organization they own
        - ADMIN user: can delete any organization

        **Constarints**:
        - Cannot delete default organizations

        **Cascading Deletions**:
        - All services and pricing versions are deleted
        - All contracts are deleted
        - All members are removed
        - All API keys are invalidated

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Organization deleted successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - cannot delete default organization or insufficient permissions
        '404':
          description: Organization not found

  /organizations/{organizationId}/members:
    post:
      summary: Add member to organization
      description: |
        Adds a user to the organization with a specified role.

        **Authentication**: User API Key

        **Permission**: 
        - Organization OWNER: can add any member with any role
        - Organization ADMIN: can add any member with any role
        - Organization MANAGER: can add any member with MANAGER/EVALUATOR roles (not OWNER/ADMIN)
        - ADMIN user: can add with any role

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - role
              properties:
                username:
                  type: string
                  example: user_to_add
                role:
                  type: string
                  enum: [ADMIN, MANAGER, EVALUATOR]
                  example: MANAGER
      responses:
        '200':
          description: Member added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Invalid member data
        '403':
          description: Forbidden - cannot grant this role (insufficient permissions)
        '404':
          description: Organization or user not found

  /organizations/{organizationId}/members/{username}:
    put:
      summary: Update member role in organization
      description: |
        Updates the role of a member within the organization. Only users with appropriate permissions can change member roles.

        **Authentication**: User API Key

        **Permission Model**:
        - **SPACE Admin**: Can promote/demote any member to any role (except OWNER)
        - **Organization OWNER**: Can promote/demote any member (except themselves) to any role (except OWNER)
        - **Organization ADMIN**: Can promote/demote any member (except OWNER and other ADMINs) to any role (except OWNER and ADMIN)
        - **Organization MANAGER**: Can promote/demote MANAGER and EVALUATOR members to lower roles (MANAGER/EVALUATOR only)
        - **Organization EVALUATOR and below**: No permission to change roles

        **Available Roles**: ADMIN, MANAGER, EVALUATOR

        **Constraints**:
        - Cannot change OWNER's role (organization owner cannot be downgraded)
        - Cannot assign OWNER role (OWNER role is special, only changed via organization transfer)
        - Cannot update a member to their current role (must be a different role)
        - Member must initially exist in the organization

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          description: The organization ID (must be valid MongoDB ObjectId)
          schema:
            type: string
            format: uuid
        - name: username
          in: path
          required: true
          description: The username of the member whose role is being updated
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - role
              properties:
                role:
                  type: string
                  enum: [ADMIN, MANAGER, EVALUATOR]
                  description: The new role to assign to the member
            examples:
              promoteToAdmin:
                summary: Promote member to ADMIN
                value:
                  role: ADMIN
              demoteToEvaluator:
                summary: Demote member to EVALUATOR
                value:
                  role: EVALUATOR
      responses:
        '200':
          description: Member role updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '400':
          description: Invalid data or request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                nonExistentMember:
                  summary: Member does not exist
                  value:
                    error: "INVALID DATA: User with username nonexistent_user is not a member of the organization."
                ownerRole:
                  summary: Cannot change owner's role
                  value:
                    error: "INVALID DATA: Cannot change the role of the organization owner."
                invalidOrganization:
                  summary: Invalid organization ID format
                  value:
                    error: "INVALID DATA: Invalid organization ID"
        '403':
          description: Forbidden - User lacks required permissions
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                noPermission:
                  summary: User cannot update member roles
                  value:
                    error: "PERMISSION ERROR: Only SPACE admins or organization-level OWNER, ADMIN and MANAGER can update member roles."
                escalatedPermission:
                  summary: Manager trying to promote to ADMIN
                  value:
                    error: "PERMISSION ERROR: Only SPACE admins or organization-level OWNER/ADMIN can add high-level members."
        '404':
          description: Organization not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                notFound:
                  summary: Organization does not exist
                  value:
                    error: "Organization with ID 000000000000000000000000 not found"
        '409':
          description: Conflict - Member already has the target role
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                sameRole:
                  summary: Member already has this role
                  value:
                    error: "CONFLICT: User with username john_doe already has the role EVALUATOR."
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                missingRole:
                  summary: Missing role field
                  value:
                    error: "Validation error: role field is required"
                invalidRole:
                  summary: Invalid role value
                  value:
                    error: "Validation error: role must be one of ADMIN, MANAGER, EVALUATOR"
                invalidRoleType:
                  summary: Role is not a string
                  value:
                    error: "Validation error: role must be a string"
                ownerRoleAttempt:
                  summary: Attempting to assign OWNER role
                  value:
                    error: "Validation error: OWNER role cannot be assigned via this endpoint"

    delete:
      summary: Remove specific member from organization
      description: |
        Removes a user from the organization.

        **Authentication**: User API Key

        **Permission**: 
        - Organization OWNER: can remove any member
        - Organization ADMIN: can remove members except other ADMINs or OWNER
        - Organization MANAGER: can remove MANAGER/EVALUATOR only  
        - Organization EVALUATOR: can only remove themselves
        - ADMIN user: can remove any member

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Member removed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '403':
          description: Forbidden
        '404':
          description: Organization or member not found

  /organizations/{organizationId}/api-keys:
    post:
      summary: Create organization API Key
      description: |
        Creates a new API Key for the organization with the specified scope.

        **Authentication**: User API Key

        **Permission**: 
        - Organization OWNER: can create any scope
        - Organization ADMIN: can create any scope
        - Organization MANAGER: can create MANAGEMENT/EVALUATION scopes only
        - ADMIN user: can create any scope

        **Scopes**:
        - `ALL`: Unrestricted access to all organization operations
        - `MANAGEMENT`: Create, update, delete operations (read access included)
        - `EVALUATION`: Read-only access to services/pricings + feature evaluation

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - keyScope
              properties:
                keyScope:
                  type: string
                  enum: [ALL, MANAGEMENT, EVALUATION]
                  example: MANAGEMENT
      responses:
        '200':
          description: API Key created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: API key added successfully
        '400':
          description: Invalid scope value
        '403':
          description: Forbidden - cannot grant this scope (MANAGER cannot create ALL scope)
        '404':
          description: Organization not found

  /organizations/{organizationId}/api-keys/{apiKeyId}:
    delete:
      summary: Remove organization API Key
      description: |
        Removes an API Key from the organization, immediately invalidating it.

        **Authentication**: User API Key

        **Permission**: 
        - Organization OWNER: can remove any key
        - Organization ADMIN: can remove any key
        - Organization MANAGER: can remove non-ALL scope keys only
        - ADMIN user: can remove any key

      tags:
        - Organizations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: apiKey
          in: path
          required: true
          schema:
            type: string
          description: The API Key value to remove
      responses:
        '200':
          description: API Key removed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '403':
          description: Forbidden - cannot remove ALL-scope key (MANAGER)
        '404':
          description: API Key not found

  /organizations/{organizationId}/services:
    get:
      summary: List services in organization
      description: |
        Lists all services configured in the organization.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: must be an organization member with any role (OWNER/ADMIN/MANAGER/EVALUATOR)
        - ADMIN user: can view services in any organization

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of services
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Service'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - not a member of this organization or insufficient scope

    post:
      summary: Create service in organization
      description: |
        Creates a new service in the organization.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: OWNER/ADMIN/MANAGER role required
        - ADMIN user: can create services in any organization

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - name
                - description
              properties:
                name:
                  type: string
                  example: Zoom
                description:
                  type: string
                  example: Video conferencing and web meeting platform
                pricing:
                  type: string
                  format: binary
                  description: Optional pricing YAML/JSON file
      responses:
        '201':
          description: Service created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '400':
          description: Invalid service data
        '403':
          description: Forbidden - insufficient permissions
        '404':
          description: Organization not found

    delete:
      summary: Delete all services in organization
      description: |
        Deletes all services and associated pricings in the organization (irreversible operation).

        **Authentication**: User API Key

        **Permission**: 
        - USER user: OWNER/ADMIN role required
        - ADMIN user: can delete services in any organization

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: All services deleted successfully
        '403':
          description: Forbidden - insufficient permissions
        '404':
          description: Organization not found

  /organizations/{organizationId}/services/{serviceName}:
    get:
      summary: Get service details
      description: |
        Retrieves detailed information about a specific service in a organization.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: must be an organization member with any role (OWNER/ADMIN/MANAGER/EVALUATOR)
        - ADMIN user: can view service details in any organization

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
          example: Zoom
      responses:
        '200':
          description: Service details including pricings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '403':
          description: Forbidden
        '404':
          description: Service not found

    put:
      summary: Update service
      description: |
        Updates service metadata (name, organization).

        **Authentication**: User API Key

        **Permission**: 
        - USER user: OWNER/ADMIN/MANAGER role required
        - ADMIN user: can update services in any organization

        **Cascading Operations**:
        - Renaming a service propagates the change by updating the corresponding `contractedServices` references in all associated contracts.
        - Updating `organizationId` triggers one of the following behaviors:
            - If contracts include **only the updated service**, each contract’s `organizationId`` is updated to reflect the new organization.
            - If contracts include **multiple contracted services**, the updated service is removed from them.

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                organizationId:
                  type: string
      responses:
        '200':
          description: Service updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '400':
          description: Invalid update data (e.g., organization not found)
        '403':
          description: Forbidden
        '404':
          description: Service not found
        '409':
          description: Service name already exists

    delete:
      summary: Disable service
      description: |
        Disables a service. Cannot be permanently deleted; use disable to mark unavailable.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: OWNER/ADMIN role required
        - ADMIN user: can disable services in any organization

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Service disabled successfully
        '403':
          description: Forbidden
        '404':
          description: Service not found

  /organizations/{organizationId}/services/{serviceName}/pricings:
    get:
      summary: List service pricings
      description: |
        Lists all pricing versions for a specific service in a organization.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: organization member with any role
        - ADMIN user: can view pricings of any service in any organization

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of pricing versions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Pricing'
        '403':
          description: Forbidden
        '404':
          description: Service not found

    post:
      summary: Add pricing version to service
      description: |
        Uploads and adds a new pricing version to the service.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: OWNER/ADMIN/MANAGER role required
        - ADMIN user: can add pricings to any service in any organization

        **Constraints**:
        - Pricing `saasName` and `serviceName` must be the same

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - pricing
              properties:
                pricing:
                  type: string
                  format: binary
                  description: Pricing file in YAML or JSON format
      responses:
        '201':
          description: Pricing version added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pricing'
        '400':
          description: Invalid pricing data
        '403':
          description: Forbidden
        '404':
          description: Service not found

  /organizations/{organizationId}/services/{serviceName}/pricings/{pricingVersion}:
    get:
      summary: Get pricing version details
      description: |
        Retrieves complete details about a specific pricing version including 
        plans, add-ons, and availability.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: organization member with any role
        - ADMIN user: can view any pricing version from any service in any organization

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
        - name: pricingVersion
          in: path
          required: true
          schema:
            type: string
          example: "1.0.0"
      responses:
        '200':
          description: Pricing version details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pricing'
        '404':
          description: Pricing version not found

    put:
      summary: Update pricing availability
      description: |
        Updates the availability status of a pricing version.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: OWNER/ADMIN/MANAGER role required
        - ADMIN user: can update availability of any pricing version from any service in any organization

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
        - name: pricingVersion
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                available:
                  type: boolean
                  example: true
      responses:
        '200':
          description: Pricing availability updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pricing'
        '403':
          description: Forbidden
        '404':
          description: Pricing version not found

    delete:
      summary: Delete pricing version
      description: |
        Removes a pricing version from the given service in the given organization (irreversible operation).

        **Authentication**: User API Key

        **Permission**: 
        - USER user: OWNER/ADMIN role required
        - ADMIN user: can delete any pricing version from any service in any organization

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
        - name: pricingVersion
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Pricing version deleted successfully
        '403':
          description: Forbidden
        '404':
          description: Pricing version not found

  /services:
    get:
      summary: List all services
      description: |
        Lists all services configured in the organization.

        **Authentication**: Organization API Key | User API Key

        **Organization API Key Permission**:
          - ALL scope: can view and filter all services from the organization
          - MANAGEMENT scope: can view and filter all services from the organization
          - EVALUATION scope: can view and filter all services from the organization

        **User API Key Permission**:
          - ADMIN user: can view all services from any organization
      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Case-insensitive partial match on service name (regex "contains").
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination. Ignored when `offset` is provided and greater than 0.
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of items to skip. When `offset` is greater than 0, it overrides `page`.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 20
          description: Max number of items to return per request.
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order by service name.
      responses:
        '200':
          description: List of all services
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Service'
        '401':
          description: Unauthorized or invalid API key
        '403':
          description: Forbidden - User API Keys cannot access this endpoint

    post:
      summary: Create service
      description: |
        Creates a new service in the organization.

        **Authentication**: Organization API Key

        **Permission**: 
          - Org Key with ALL or MANAGEMENT scope

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - name
                - description
              properties:
                name:
                  type: string
                description:
                  type: string
                pricing:
                  type: string
                  format: binary
      responses:
        '201':
          description: Service created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '403':
          description: Forbidden

    delete:
      summary: Delete all services
      description: |
        Deletes all services and associated pricings in the organization (irreversible operation).

        **Authentication**: Organization API Key | User API Key

        **Organization Permission**:
          - ALL scope: delete all services from the organization.

        **User Permission**:
          - ADMIN user: can delete all services allocated in a SPACE instance.
      tags:
        - Services
      security:
        - ApiKeyAuth: []
      responses:
        '204':
          description: All services deleted
        '403':
          description: Forbidden

  /services/{serviceName}:
    get:
      summary: Get service
      description: |
        Retrieves detailed information about a specific service in a organization.

        **Authentication**: Organization API Key

        **Permission**: Org Key with any scope

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Service details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '404':
          description: Service not found

    put:
      summary: Update service
      description: |
        Updates service metadata (name, organization).

        **Authentication**: Organization API Key

        **Permission**: 
          - ALL scope: can update service name and organization.
          - MANAGEMENT scope: can update service name and organization

        **Cascading Operations**:
        - Renaming a service propagates the change by updating the corresponding `contractedServices` references in all associated contracts.
        - Updating `organizationId` triggers one of the following behaviors:
            - If contracts include **only the updated service**, each contract’s `organizationId` is updated to reflect the new organization.
            - If contracts include **multiple contracted services**, the updated service is removed from them.

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                organizationId:
                  type: string
      responses:
        '200':
          description: Service updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '403':
          description: Forbidden

    delete:
      summary: Disable service
      description: |
        Disables a service. Cannot be permanently deleted; use disable to mark unavailable.

        **Authentication**: Organization API Key

        **Permission**:
          - ALL scope: can disable any service from the organization.

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Service disabled
        '403':
          description: Forbidden

  /services/{serviceName}/pricings:
    get:
      summary: List pricings
      description: |
        Lists all pricing versions for a specific service in a organization.

        **Authentication**: Organization API Key

        **Permission**: Org Key with any scope

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of pricings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Pricing'
        '404':
          description: Service not found

    post:
      summary: Add pricing
      description: |
        Uploads and adds a new pricing version to the service.

        **Constraints**:
        - Pricing `saasName` and `serviceName` must be the same

        **Authentication**: Organization API Key

        **Permission**: 
          - ALL scope: can add pricings to any service in the organization.
          - MANAGEMENT scope: can add pricings to any service in the organization.

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                pricing:
                  type: string
                  format: binary
      responses:
        '201':
          description: Pricing added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pricing'
        '403':
          description: Forbidden

  /services/{serviceName}/pricings/{pricingVersion}:
    get:
      summary: Get pricing
      description: |
        Retrieves complete details about a specific pricing version including 
        plans, add-ons, and availability.

        **Authentication**: Organization API Key

        **Permission**: Org Key with any scope

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
        - name: pricingVersion
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Pricing details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pricing'
        '404':
          description: Pricing not found

    put:
      summary: Update pricing availability
      description: |
        Updates the availability status of a pricing version.

        **Authentication**: Organization API Key only

        **Permission**:
          - ALL scope: can update availability of any pricing version from any service in the organization.
          - MANAGEMENT scope: can update availability of any pricing version from any service in the organization.

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
        - name: pricingVersion
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                available:
                  type: boolean
      responses:
        '200':
          description: Pricing updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pricing'
        '403':
          description: Forbidden

    delete:
      summary: Delete pricing
      description: |
        Removes a pricing version from the given service in the given organization (irreversible operation).

        **Authentication**: Organization API Key

        **Permission**:
          - ALL scope: can delete any pricing version from any service in the organization.

      tags:
        - Services
      security:
        - ApiKeyAuth: []
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            type: string
        - name: pricingVersion
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Pricing deleted
        '403':
          description: Forbidden

  /organizations/{organizationId}/contracts:
    get:
      summary: List contracts in organization
      description: |
        Lists all contracts in the organization.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: must be an organization member with any role (OWNER/ADMIN/MANAGER/EVALUATOR)
        - ADMIN user: can view contracts in any organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: username
          in: query
          required: false
          schema:
            type: string
          description: Filter contracts by username (case-insensitive regex match)
        - name: firstName
          in: query
          required: false
          schema:
            type: string
          description: Filter contracts by user's first name (case-insensitive regex match)
        - name: lastName
          in: query
          required: false
          schema:
            type: string
          description: Filter contracts by user's last name (case-insensitive regex match)
        - name: email
          in: query
          required: false
          schema:
            type: string
          description: Filter contracts by user email (case-insensitive regex match)
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 1
          description: |
            Page number for pagination (1-based). 
            **Note**: Ignored when `offset > 0`.
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
          description: |
            Number of contracts to skip (0-based offset). 
            **Precedence**: When `offset > 0`, it overrides the `page` parameter.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
          description: Maximum number of contracts to return per page
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [firstName, lastName, username, email]
          description: Field to sort contracts by
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order (ascending or descending)
      responses:
        '200':
          description: List of contracts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Contract'
        '403':
          description: Forbidden

    post:
      summary: Create contract in organization
      description: |
        Creates a new subscription contract in the organization.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: must have OWNER/ADMIN/MANAGER role
        - ADMIN user: can create contracts in any organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '201':
          description: Contract created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contract'
        '403':
          description: Forbidden

    delete:
      summary: Delete all contracts in organization
      description: |
        Deletes all subscription contracts in the organization (irreversible).

        **Authentication**: User API Key

        **Permission**: 
        - USER user: must have OWNER/ADMIN role with the organization
        - ADMIN user: can delete contracts in any organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: All contracts deleted
        '403':
          description: Forbidden

  /organizations/{organizationId}/contracts/{userId}:
    get:
      summary: Get contract details
      description: |
        Retrieves details of a specific user's contract in the organization.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: must be an organization member with any role (OWNER/ADMIN/MANAGER/EVALUATOR)
        - ADMIN user: can view contracts in any organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Contract details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contract'
        '404':
          description: Contract not found

    put:
      summary: Update contract (novate)
      description: |
        Updates contract details (contract novation - subscription composition change).

        **Authentication**: User API Key

        **Permission**: 
        - USER user: must have OWNER/ADMIN/MANAGER role
        - ADMIN user: can update contracts in any organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Contract updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contract'
        '403':
          description: Forbidden

    delete:
      summary: Delete contract
      description: |
        Deletes a specific subscription contract.

        **Authentication**: User API Key

        **Permission**: 
        - USER user: must have OWNER/ADMIN role in the organization
        - ADMIN user: can delete contracts in any organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Contract deleted
        '403':
          description: Forbidden

  /contracts:
    get:
      summary: List all contracts
      description: |
        Lists all contracts in the organization.

        **Authentication**: User API Key (ADMIN) | Organization API Key

        **User Permission**: 
        - ADMIN user: can view all contracts from any organization

        **Organization Permission**:
        - ALL scope: can view all contracts from the organization
        - MANAGEMENT scope: can view all contracts from the organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: username
          in: query
          required: false
          schema:
            type: string
          description: Filter contracts by username (case-insensitive regex match)
        - name: firstName
          in: query
          required: false
          schema:
            type: string
          description: Filter contracts by user's first name (case-insensitive regex match)
        - name: lastName
          in: query
          required: false
          schema:
            type: string
          description: Filter contracts by user's last name (case-insensitive regex match)
        - name: email
          in: query
          required: false
          schema:
            type: string
          description: Filter contracts by user email (case-insensitive regex match)
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 1
          description: |
            Page number for pagination (1-based). 
            **Note**: Ignored when `offset > 0`.
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
          description: |
            Number of contracts to skip (0-based offset). 
            **Precedence**: When `offset > 0`, it overrides the `page` parameter.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
          description: Maximum number of contracts to return per page
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [firstName, lastName, username, email]
          description: Field to sort contracts by
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order (ascending or descending)
      responses:
        '200':
          description: List of all contracts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Contract'

    post:
      summary: Create contract
      description: |
        Creates a new subscription contract in the organization.

        **Authentication**: User API Key (ADMIN) | Organization API Key

        **User Permission**: 
        - ADMIN user: can create contracts in any organization

        **Organization Permission**:
        - ALL scope: can create contracts in the organization
        - MANAGEMENT scope: can create contracts in the organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '201':
          description: Contract created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contract'

    delete:
      summary: Delete all contracts
      description: |
        Deletes all subscription contracts in the organization (irreversible).

        **Authentication**: User API Key (ADMIN) | Organization API Key

        **User Permission**: 
        - ADMIN user: can delete all contracts from any organization

        **Organization Permission**:
        - ALL scope: can delete all contracts from the organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      responses:
        '204':
          description: All contracts deleted

  /contracts/{userId}:
    get:
      summary: Get contract
      description: |
        Retrieves details of a specific user's contract in the organization.

        **Authentication**: User API Key (ADMIN) | Organization API Key

        **User Permission**: 
        - ADMIN user: can view contracts in any organization

        **Organization Permission**:
        - ALL scope: can view contracts in the organization
        - MANAGEMENT scope: can view contracts in the organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Contract details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contract'

    put:
      summary: Update contract
      description: |
        Updates contract details (contract novation - subscription composition change).

        **Authentication**: User API Key (ADMIN) | Organization API Key

        **User Permission**: 
        - ADMIN user: can update contracts in any organization

        **Organization Permission**:
        - ALL scope: can update contracts in the organization
        - MANAGEMENT scope: can update contracts in the organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Contract updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contract'

    delete:
      summary: Delete contract
      description: |
        Deletes a specific subscription contract.

        **Authentication**: User API Key (ADMIN) | Organization API Key

        **User Permission**: 
        - ADMIN user: can delete contracts in any organization

        **Organization Permission**:
        - ALL scope: can delete contracts in the organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Contract deleted

  /contracts/{userId}/usageLevels:
    put:
      summary: Reset usage levels
      description: |
        Resets usage level counters for a contract.

        **Authentication**: User API Key (ADMIN) | Organization API Key

        **User Permission**: 
        - ADMIN user: can reset usage levels in any organization

        **Organization Permission**:
        - ALL scope: can reset usage levels in the organization
        - MANAGEMENT scope: can reset usage levels in the organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Usage levels reset
          content:
            application/json:
              schema:
                type: object

  /contracts/{userId}/userContact:
    put:
      summary: Update user contact information
      description: |
        Updates the contact information stored in a contract.

        **Authentication**: User API Key (ADMIN) | Organization API Key

        **User Permission**: 
        - ADMIN user: can update contact information in any organization

        **Organization Permission**:
        - ALL scope: can update contact information in the organization
        - MANAGEMENT scope: can update contact information in the organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Contact updated
          content:
            application/json:
              schema:
                type: object

  /contracts/{userId}/billingPeriod:
    put:
      summary: Update billing period
      description: |
        Updates the billing period configuration for a contract.

        **Authentication**: User API Key (ADMIN) | Organization API Key

        **User Permission**: 
        - ADMIN user: can update billing period in any organization

        **Organization Permission**:
        - ALL scope: can update billing period in the organization
        - MANAGEMENT scope: can update billing period in the organization

      tags:
        - Contracts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Billing period updated
          content:
            application/json:
              schema:
                type: object

  /features:
    get:
      summary: List available features
      description: |
        Retrieves all features available in the system for evaluation.

        **Authentication**: Organization API Key

        **Permission**: Org Key with any scope (ALL/MANAGEMENT/EVALUATION)

      tags:
        - Features
      security:
        - ApiKeyAuth: []
      parameters:
        - name: featureName
          in: query
          required: false
          schema:
            type: string
          description: Filter features by name (case-insensitive regex match)
        - name: serviceName
          in: query
          required: false
          schema:
            type: string
          description: Filter features by service name (case-insensitive regex match)
        - name: pricingVersion
          in: query
          required: false
          schema:
            type: string
          description: Filter features by pricing version
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 1
          description: |
            Page number for pagination (1-based). 
            Ignored when offset is greater than 0.
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
          description: |
            Number of features to skip (0-based offset). 
            When offset is greater than 0, it overrides the page parameter.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
          description: Maximum number of features to return per page
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [featureName, serviceName]
          description: Field to sort features by
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order (ascending or descending)
        - name: show
          in: query
          required: false
          schema:
            type: string
            enum: [active, archived, all]
          description: Filter features by status (active, archived, or all)
      responses:
        '200':
          description: List of available features
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Feature'

  /features/{userId}:
    post:
      summary: Evaluate features for user
      description: |
        Evaluates which features are available for a specific user based on their 
        subscription contract and pricing plan.

        **Authentication**: Organization API Key only

        **Permission**: Org Key with any scope

      tags:
        - Features
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
        - name: details
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Return detailed feature evaluation information including limits and consumption
        - name: server
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Perform evaluation using server-side context instead of token-based evaluation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Feature evaluation results
          content:
            application/json:
              schema:
                type: object
                properties:
                  features:
                    type: array
                    items:
                      type: object

  /features/{userId}/pricing-token:
    post:
      summary: Generate pricing token
      description: |
        Generates a JWT token containing the user's pricing and subscription information 
        for use by client-side feature evaluation.

        **Authentication**: Organization API Key only

        **Permission**: Org Key with any scope

      tags:
        - Features
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
        - name: server
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Perform evaluation using server-side context instead of token-based evaluation
      responses:
        '200':
          description: Pricing token generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT token with pricing information

  /features/{userId}/{featureId}:
    post:
      summary: Evaluate single feature
      description: |
        Evaluates a specific feature for a user with expected consumption, returning 
        whether the feature is allowed and any usage warnings.

        **Authentication**: Organization API Key only

        **Permission**: Org Key with any scope

      tags:
        - Features
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
        - name: featureId
          in: path
          required: true
          schema:
            type: string
        - name: server
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Perform evaluation using server-side context instead of token-based evaluation
        - name: revert
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Reset feature usage levels after evaluation
        - name: latest
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Use the latest feature configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                expectedConsumption:
                  type: number
                  example: 1.5
      responses:
        '200':
          description: Feature evaluation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  allowed:
                    type: boolean
                  reason:
                    type: string

  /analytics/api-calls:
    get:
      summary: Get API call statistics
      description: |
        Retrieves statistics about API call usage in the system.

        **Authentication**: User API Key (ADMIN, USER) | Organization API Key

        **User Permission**:
          - USER user: can view API call statistics
          - ADMIN user: can view API call statistics

        **Organization Permission**:
          - ALL scope: can view API call statistics
          - MANAGEMENT scope: can view API call statistics
          - EVALUATION scope: can view API call statistics

      tags:
        - Analytics
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: API call statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  byEndpoint:
                    type: object

  /analytics/evaluations:
    get:
      summary: Get feature evaluation statistics
      description: |
        Retrieves statistics about feature evaluations performed by the system.

        **Authentication**: User API Key (ADMIN, USER) | Organization API Key

        **User Permission**:
          - USER user: can view feature evaluation statistics
          - ADMIN user: can view feature evaluation statistics

        **Organization Permission**:
          - ALL scope: can view feature evaluation statistics
          - MANAGEMENT scope: can view feature evaluation statistics
          - EVALUATION scope: can view feature evaluation statistics

      tags:
        - Analytics
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Evaluation statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalEvaluations:
                    type: integer
                  byFeature:
                    type: object

  /cache/get:
    get:
      summary: Get cached value
      description: |
        Retrieves a value from the system cache by key.

        **Authentication**: User API Key (ADMIN only)

        **Permission**: ADMIN role required

      tags:
        - Cache
      security:
        - ApiKeyAuth: []
      parameters:
        - name: key
          in: query
          required: true
          schema:
            type: string
          example: pricing_cache_zoom
      responses:
        '200':
          description: Cached value retrieved
          content:
            application/json:
              schema:
                type: object

  /cache/set:
    post:
      summary: Set cache value
      description: |
        Stores a value in the system cache with the specified key.

        **Authentication**: User API Key (ADMIN only)

        **Permission**: ADMIN role required

      tags:
        - Cache
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - key
                - value
              properties:
                key:
                  type: string
                  example: pricing_cache_zoom
                value:
                  type: object
      responses:
        '200':
          description: Value cached successfully
          content:
            application/json:
              schema:
                type: object

  /events/status:
    get:
      summary: Get event service status
      description: |
        Checks if the WebSocket event service is running and operational.

        **Authentication**: Public (no API key required)

      tags:
        - Events
      responses:
        '200':
          description: Service status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: The WebSocket event service is active

  # /events/test-event:
  #   post:
  #     summary: Send test event (for testing)
  #     description: |
  #       Sends a test event to all connected WebSocket clients (used for testing purposes).

  #       **Authentication**: Public

  #     tags:
  #       - Events
  #     requestBody:
  #       required: true
  #       content:
  #         application/json:
  #           schema:
  #             type: object
  #             required:
  #               - serviceName
  #               - pricingVersion
  #             properties:
  #               serviceName:
  #                 type: string
  #                 example: Zoom
  #               pricingVersion:
  #                 type: string
  #                 example: "1.0"
  #     responses:
  #       '200':
  #         description: Event sent successfully
  #         content:
  #           application/json:
  #             schema:
  #               type: object
  #               properties:
  #                 success:
  #                   type: boolean
  #                 message:
  #                   type: string

  /events/client:
    get:
      summary: Get WebSocket client HTML
      description: |
        Returns an HTML file for testing WebSocket connections to the event service.

        **Authentication**: Public

      tags:
        - Events
      responses:
        '200':
          description: WebSocket client HTML
          content:
            text/html:
              schema:
                type: string

  /healthcheck:
    get:
      summary: Service health check
      description: |
        Verifies that the SPACE API service is operational and responsive. 
        Use this endpoint for load balancer health checks.

        **Authentication**: Public (no API key required)

      tags:
        - Healthcheck
      responses:
        '200':
          description: Service is operational
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Service is up and running!

components:
  schemas:
    User:
      type: object
      properties:
        username:
          type: string
          example: john_doe
        apiKey:
          type: string
          example: usr_abc123def456ghi789
        role:
          type: string
          enum: [ADMIN, USER]
          example: ADMIN
        createdAt:
          type: string
          format: date-time

    Organization:
      type: object
      properties:
        id:
          type: string
          example: 507f1f77bcf86cd799439012
        name:
          type: string
          example: ACME Corporation
        owner:
          type: string
          example: john_doe
        default:
          type: boolean
          example: false
        members:
          type: array
          items:
            type: object
            properties:
              username:
                type: string
              role:
                type: string
                enum: [OWNER, ADMIN, MANAGER, EVALUATOR]
        apiKeys:
          type: array
          items:
            type: object
            properties:
              key:
                type: string
              scope:
                type: string
                enum: [ALL, MANAGEMENT, EVALUATION]
        createdAt:
          type: string
          format: date-time

    Service:
      type: object
      properties:
        name:
          type: string
          example: Zoom
        description:
          type: string
          example: Video conferencing platform
        organization:
          type: string
        available:
          type: boolean
        pricings:
          type: array
          items:
            $ref: '#/components/schemas/Pricing'
        createdAt:
          type: string
          format: date-time

    Pricing:
      type: object
      properties:
        version:
          type: string
          example: "1.0.0"
        service:
          type: string
        available:
          type: boolean
        plans:
          type: array
          items:
            type: object
        addOns:
          type: array
          items:
            type: object
        createdAt:
          type: string
          format: date-time

    Contract:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        organization:
          type: string
        services:
          type: array
          items:
            type: object
        billingPeriod:
          type: object
        usageLevels:
          type: object
        userContact:
          type: object
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Feature:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
          example: Premium Support
        description:
          type: string
        service:
          type: string

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: |
        API Key for authentication. Two types are supported:
        - **User API Key** (format: `usr_*`): Obtained from POST /users/authenticate endpoint
        - **Organization API Key** (format: `org_*`): Created in organization settings

